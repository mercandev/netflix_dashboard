<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Menü -->
        <nav class="navbar">
            <div class="logo">
                <img src="/images/netflix-logo-white.png" alt="Netflix Logo">
            </div>
            <ul class="menu">
                <li><a href="/main">Ana Sayfa</a></li>
                <li><a href="/users">Kullanıcılar</a></li>
                <li><a href="/movies">Filmler</a></li>
                <li><a href="/series">Diziler</a></li>
            </ul>
            <div class="session-info">
                <span id="welcome-message">Hoşgeldiniz, <%= username %>!</span>
                <div class="dropdown">
                    <span id="dropdown-btn">▼</span>
                    <div id="dropdown-menu" class="dropdown-content">
                        <a href="/logout" class="logout">Çıkış</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Kullanıcılar ve Bütçe Kutuları -->
        <div class="stats-container">
            <!-- 1. Aktif Kullanıcılar Kutusu -->
            <div class="stats-box active">
                <i class="material-icons">home</i>
                <p><strong>Aktif Kullanıcılar:</strong></p>
                <p class="stats-count"><%= activeUserCount %></p>
            </div>

            <!-- 2. Kapalı Kullanıcılar Kutusu -->
            <div class="stats-box inactive">
                <i class="material-icons">block</i>
                <p><strong>Kapalı Kullanıcılar:</strong></p>
                <p class="stats-count"><%= inactiveUserCount %></p>
            </div>

            <!-- 3. Bütçe Kutusu -->
            <div class="stats-box budget">
                <i class="material-icons">attach_money</i>
                <p><strong>Bütçe:</strong></p>
                <p class="stats-count"><%= totalBudget %> $</p>
            </div>

            <!-- 4. Toplam Diziler Kutusu -->
            <div class="stats-box series">
                <i class="material-icons">tv</i>
                <p><strong>Toplam Diziler:</strong></p>
                <p class="stats-count"><%= seriesCount %></p>
            </div>

            <!-- 5. Toplam Filmler Kutusu -->
            <div class="stats-box films">
                <i class="material-icons">movie</i>
                <p><strong>Toplam Filmler:</strong></p>
                <p class="stats-count"><%= filmsCount %></p>
            </div>
        </div>

        <h4 style="text-align: left; margin-top: 30px; margin-left: 25px;">Orjinal Dizi İçeriğimizin Tür ve Dizi Başına İzlenme Durumları</h4>

        <!-- Grafiklerin yerleşimi (yan yana) -->
        <div class="chart-container">
            <!-- Donut Chart -->
            <div class="chart-item">
                <canvas id="donutChart"></canvas>
            </div>

            <!-- Line Chart -->
            <div class="chart-item">
                <!-- Dropdown Menü -->
                <div style="margin-top: 10px;">
                    <select id="chartDropdown" style="padding: 5px; font-size: 14px;">
                        <option value="10">1-10</option>
                        <option value="20">10-20</option>
                        <option value="30">20-30</option>
                        <option value="40">30-40</option>
                        <option value="50">40-50</option>
                    </select>
                </div>
                <canvas id="lineChart"></canvas>
            </div>
        </div>

        <script>
            // genreData'yı doğrudan JavaScript dizisi olarak alıyoruz
            var genreData = <%- JSON.stringify(genreData) %>;  // Veriyi doğrudan güvenli şekilde alıyoruz

            console.log(genreData);  // Veriyi kontrol et

            var labels = genreData.map(item => item.ad);
            var data = genreData.map(item => item.adet);

            var ctx = document.getElementById('donutChart').getContext('2d');
            var donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'İzlenme Türleri',
                        data: data,
                        backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#4bc0c0'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return tooltipItem.label + ': ' + tooltipItem.raw + ' kişi';
                                }
                            }
                        }
                    }
                }
            });

            function updateLineChart(lineChartData) {
    var lineLabels = lineChartData.map(item => item.dizi_adi);
    var lineData = lineChartData.map(item => item.izlenme_adet);

    var ctx = document.getElementById('lineChart').getContext('2d');

    // Eğer önceki bir grafik varsa, onu temizle
    if (window.lineChart instanceof Chart) {
        window.lineChart.destroy();  // Geçerli bir grafik nesnesi varsa yok et
    }

    // Yeni bir grafik nesnesi oluştur
    window.lineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: lineLabels,
            datasets: [{
                label: 'İzlenme Durumu',
                data: lineData,
                borderColor: 'blue',
                fill: false
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

            // Dropdown seçim olayını dinleyerek veriyi alıyoruz
            document.getElementById('chartDropdown').addEventListener('change', function() {
                var offsetValue = this.value;  // Dropdown'dan seçilen değeri alıyoruz

                // AJAX isteği yapıyoruz
                fetch(`/get-line-chart-data?offset=${offsetValue}`)
                    .then(response => response.json())
                    .then(data => {
                        // Line chart'ı güncelliyoruz
                        updateLineChart(data);
                    })
                    .catch(error => console.error('Veri alınırken hata oluştu:', error));
            });

            // Sayfa ilk açıldığında, default 1-10 seçili olmalı ve veriyi yüklemeliyiz
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('chartDropdown').value = '10';  // Default olarak 1-10 seçili olacak
                document.getElementById('chartDropdown').dispatchEvent(new Event('change'));  // Seçili değeri tetikle
            });
        </script>

    </div>
</body>
</html>